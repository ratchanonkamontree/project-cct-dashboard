<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project CCT Dashboard V38.1</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{font-family:'Sarabun',sans-serif;background:#f0f4f8}
.card{background:#fff;border-radius:16px;padding:20px;border:1px solid #e2e8f0;box-shadow:0 4px 6px rgba(0,0,0,.05)}
.metric-value{font-size:30px;font-weight:700}
#loading{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999}
.loader{border:4px solid #eee;border-top:4px solid #2563eb;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}
@keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="loading">
  <div class="loader mb-4"></div>
  <div class="font-bold">Loading Project CCT Dashboard...</div>
</div>

<div id="main-app" class="hidden p-6 max-w-7xl mx-auto">

<div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-2">
  <h1 class="text-2xl font-bold">Project CCT Dashboard V38.1</h1>
  <div class="text-sm text-gray-500">
    อัปเดตข้อมูลล่าสุด (จาก Google): 
    <span id="last-updated" class="font-semibold text-blue-600">-</span>
  </div>
</div>

<!-- KPI -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
  <div class="card"><div>Total Jobs</div><div id="kpi-jobs" class="metric-value">0</div></div>
  <div class="card"><div>PBOQ</div><div id="kpi-pboq" class="metric-value">0</div></div>
  <div class="card"><div>FBOQ</div><div id="kpi-fboq" class="metric-value">0</div></div>
  <div class="card"><div>Work Order</div><div id="kpi-wo" class="metric-value">0</div></div>
  <div class="card"><div>PO</div><div id="kpi-po" class="metric-value">0</div></div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="card"><div id="chart-region" style="height:300px"></div></div>
  <div class="card"><div id="chart-project" style="height:300px"></div></div>
  <div class="card"><div id="chart-status" style="height:300px"></div></div>
  <div class="card"><div id="chart-pboq" style="height:300px"></div></div>
</div>

</div>

<script>
/**************** CONFIG ****************/
const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_QKLW_J1dfnepcwsdExV1aBiX3gc7voJC1Pckm5-jkyG1AEjfHEdFz9x2CCOPVEolqIAWPun7721c/pub?gid=0&single=true&output=csv";
const REFRESH_RATE = 20000;

/**************** STATE ****************/
let rawData=[];
let filteredData=[];
let sheetSummary={jobs:0};
let isUpdateInProgress=false;

/**************** INIT ****************/
window.onload=()=>{
  fetchData();
  setInterval(fetchData,REFRESH_RATE);
};

/**************** FETCH ****************/
function fetchData(){
  if(isUpdateInProgress) return;
  isUpdateInProgress=true;

  const url=GVIZ_URL+"&_t="+Date.now();
  Papa.parse(url,{
    download:true,
    skipEmptyLines:true,
    complete:(res)=>{
      successHandler(res);
      isUpdateInProgress=false;
    },
    error:(err)=>{
      console.error(err);
      isUpdateInProgress=false;
    }
  });
}

/**************** LAST MODIFIED ****************/
async function fetchLastModifiedTime(){
  try{
    const res = await fetch(GVIZ_URL, { method: 'HEAD', cache: 'no-store' });
    const lm = res.headers.get('last-modified');
    if(lm){
      const dt = new Date(lm);
      const el = document.getElementById("last-updated");
      if(el){
        el.innerText = dt.toLocaleString("th-TH");
      }
    }
  }catch(err){
    console.warn("Cannot fetch last-modified time", err);
  }
}

/**************** PARSE ****************/
function findCol(headers,keys){
  return headers.findIndex(h=>keys.some(k=>h===k||h.includes(k)));
}

function successHandler(results){
  if(!results.data||results.data.length<3) return;

  const rows=results.data;

  if(rows[0] && /^\d/.test(rows[0][0])){
    sheetSummary.jobs=parseInt(rows[0][0].replace(/,/g,''))||0;
  }

  const headers=rows[1].map(h=>h.toString().toLowerCase().trim());

  const colMap={
    id:findCol(headers,['cct']),
    project:findCol(headers,['project']),
    region:findCol(headers,['region','sub']),
    status:findCol(headers,['status']),
    wo:findCol(headers,['work','wo']),
    po:findCol(headers,['po']),
    pboq:findCol(headers,['pboq']),
    fboq:findCol(headers,['fboq'])
  };

  rawData=rows.slice(2).map(r=>{
    const id=r[colMap.id];
    if(!id||!/^cct/i.test(id.toString().trim())) return null;
    return{
      id:id,
      project:r[colMap.project]||'Unknown',
      region:r[colMap.region]||'Unknown',
      status:r[colMap.status]||'Unknown',
      wo:r[colMap.wo]||'',
      po:r[colMap.po]||'',
      pboq:parseMoney(r[colMap.pboq]),
      fboq:parseMoney(r[colMap.fboq])
    };
  }).filter(Boolean);

  filteredData=[...rawData];
  renderDashboard();

  document.getElementById("loading").style.display="none";
  document.getElementById("main-app").classList.remove("hidden");

  fetchLastModifiedTime(); // ✅ เวลาอัปเดตจริงจาก Google
}

function parseMoney(v){
  if(!v) return 0;
  return parseFloat(v.toString().replace(/[^\d.-]/g,''))||0;
}

/**************** RENDER ****************/
function countBy(data,key){
  const m={};
  data.forEach(d=>m[d[key]]=(m[d[key]]||0)+1);
  return m;
}

function groupStatus(data){
  const map={};
  data.forEach(d=>{
    if(!map[d.project]) map[d.project]={};
    map[d.project][d.status]=(map[d.project][d.status]||0)+1;
  });
  return map;
}

function clearDashboard(){
  ['chart-region','chart-project','chart-status','chart-pboq'].forEach(id=>Plotly.purge(id));
  document.querySelectorAll('[id^="kpi-"]').forEach(el=>el.innerText='0');
}

function renderDashboard(){
  const active=filteredData.filter(d=>d.project!=='Unknown');
  if(active.length===0){
    clearDashboard();
    return;
  }

  const total=active.length;
  const pboq=active.reduce((s,d)=>s+d.pboq,0);
  const fboq=active.reduce((s,d)=>s+d.fboq,0);
  const hasWO=active.filter(d=>d.wo).length;
  const hasPO=active.filter(d=>d.wo&&d.po).length;

  updateKPI("kpi-jobs",total);
  updateKPI("kpi-pboq",pboq);
  updateKPI("kpi-fboq",fboq);
  updateKPI("kpi-wo",hasWO);
  updateKPI("kpi-po",hasPO);

  const layout={margin:{t:20,l:40,r:20,b:40},paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)'};
  const config={displayModeBar:false,responsive:true};

  const r=countBy(active,'region');
  Plotly.react('chart-region',[{x:Object.keys(r),y:Object.values(r),type:'bar'}],layout,config);

  const p=countBy(active,'project');
  Plotly.react('chart-project',[{y:Object.keys(p),x:Object.values(p),type:'bar',orientation:'h'}],layout,config);

  const grouped=groupStatus(active);
  const statuses=[...new Set(active.map(d=>d.status))];
  const traces=statuses.map(s=>({
    name:s,
    type:'bar',
    x:Object.keys(grouped),
    y:Object.keys(grouped).map(p=>grouped[p][s]||0)
  }));
  Plotly.react('chart-status',traces,{...layout,barmode:'stack'},config);

  const pb={};
  active.forEach(d=>pb[d.project]=(pb[d.project]||0)+d.pboq);
  Plotly.react('chart-pboq',[{labels:Object.keys(pb),values:Object.values(pb),type:'pie',hole:.5}],layout,config);
}

function updateKPI(id,val){
  document.getElementById(id).innerText=val.toLocaleString();
}

/**************** RESIZE ****************/
let resizeTimer;
window.onresize=()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(renderDashboard,300);
};
</script>

</body>
</html>
