<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project CCT Dashboard (V42 Anti-Bounce)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; color: #1e293b; }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); height: 100%; transition: transform 0.2s ease; border: 1px solid #e2e8f0; contain: content; }
        .card:hover { transform: translateY(-3px); }
        .metric-value { font-size: 32px; font-weight: 700; color: #0f172a; line-height: 1.2; }
        .metric-label { font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: #f8fafc; }
        .scrollable-table::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; will-change: opacity; transition: opacity 0.3s; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .online-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); animation: pulse 2s infinite; }
        /* Modal for Paste */
        #paste-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; }
        #paste-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        /* Debug Table */
        .debug-container { margin-top: 40px; padding: 20px; background: #fff; border-radius: 12px; border: 1px dashed #ccc; }
        .debug-table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 12px; }
        .debug-table th, .debug-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .debug-table th { background-color: #f3f4f6; color: #374151; }
    </style>
</head>
<body>
    <div id="paste-modal">
        <div id="paste-content">
            <h3 class="text-xl font-bold mb-4">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (Manual Input)</h3>
            <textarea id="csv-paste-area" class="w-full h-64 border rounded p-2 text-xs font-mono mb-4" placeholder="Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closePasteModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="processPasteData(true)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</button>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="loader mb-6"></div>
        <div class="text-2xl font-bold text-gray-800">Project CCT Dashboard</div>
        <div class="text-sm text-gray-500 mt-2" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time...</div>
        <div class="text-xs text-gray-400 mt-4 font-mono bg-gray-50 px-3 py-1 rounded" id="loading-debug">V42 Anti-Bounce Logic</div>
        <div id="fallback-ui" class="hidden mt-8 text-center animate-fade-in flex flex-col gap-3">
            <p class="text-red-500 mb-2 text-sm font-medium">‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</p>
            <button onclick="openPasteModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center justify-center gap-2">
                <i class="fas fa-paste"></i> <span>‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</span>
            </button>
            <label class="cursor-pointer bg-white border border-gray-300 hover:border-blue-500 text-gray-700 hover:text-blue-600 font-bold py-2 px-6 rounded-full shadow-sm transition flex items-center justify-center gap-2">
                <i class="fas fa-file-upload"></i> <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
            </label>
        </div>
    </div>

    <div id="main-app" class="hidden min-h-screen pb-12">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm backdrop-blur-md bg-opacity-95">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-2 rounded-lg shadow-md">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div>
                            <span class="font-bold text-xl text-gray-800 tracking-tight">Project CCT</span>
                            <span class="text-xs text-gray-500 block font-normal">Real-time Analytics System</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right hidden md:block">
                            <div class="text-xs text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Time)</div>
                            <div id="current-time-display" class="text-sm font-bold text-gray-700 font-mono">--:--:--</div>
                        </div>
                        <div class="text-right hidden sm:block border-l pl-4 border-gray-200">
                            <div class="text-xs text-gray-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ (Data Updated)</div>
                            <div id="last-updated" class="text-sm font-bold text-blue-600 font-mono">--:--:--</div>
                        </div>
                        <div id="status-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-medium border border-green-100">
                            <span class="online-dot"></span> Live Sync
                        </div>
                        <button onclick="manualRefresh()" id="refresh-btn" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-gray-100 rounded-full transition duration-300">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white border border-gray-200 rounded-xl p-4 mb-8 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 p-2 rounded-full text-blue-600"><i class="fas fa-balance-scale"></i></div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">Data Integrity Check</div>
                            <div class="text-xs text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Sheet SUM (Cell B1)</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-6 text-sm w-full md:w-auto justify-end">
                        <div class="flex flex-col items-center px-4 border-r border-gray-100">
                            <span class="text-xs text-gray-400 mb-1">Sheet Target (B1)</span>
                            <span class="font-bold text-gray-700 text-lg" id="sheet-jobs-display">-</span>
                        </div>
                        <div class="flex flex-col items-center px-4 border-r border-gray-100">
                            <span class="text-xs text-green-600 font-bold mb-1">Actual Rows (Count)</span>
                            <span class="font-bold text-blue-600 text-lg" id="calc-jobs-display">-</span>
                        </div>
                        <div class="flex flex-col items-center px-4">
                            <span class="text-xs text-gray-400 mb-1">Difference</span>
                            <span class="font-bold text-gray-400 text-lg" id="diff-jobs-display">0</span>
                        </div>
                        <div id="data-status-icon" class="text-2xl text-gray-300 pl-2 self-center">
                            <i class="fas fa-circle-notch fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 mb-8">
                <div class="flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-700 font-semibold">
                        <i class="fas fa-filter text-blue-500"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Filters)
                    </div>
                    <div class="flex gap-3 flex-wrap w-full md:w-auto">
                        <div class="relative group flex-1 md:flex-none">
                            <button class="w-full md:w-auto px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 hover:bg-white hover:border-blue-400 flex items-center justify-between gap-3">
                                <span class="font-medium">Projects</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                            </button>
                            <div class="absolute top-full right-0 mt-2 w-64 bg-white border border-gray-100 rounded-xl shadow-xl hidden group-hover:block z-50 p-3 max-h-80 overflow-y-auto" id="filter-project"></div>
                        </div>
                        <div class="relative group flex-1 md:flex-none">
                            <button class="w-full md:w-auto px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 hover:bg-white hover:border-blue-400 flex items-center justify-between gap-3">
                                <span class="font-medium">Regions</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                            </button>
                            <div class="absolute top-full right-0 mt-2 w-48 bg-white border border-gray-100 rounded-xl shadow-xl hidden group-hover:block z-50 p-3 max-h-80 overflow-y-auto" id="filter-region"></div>
                        </div>
                        <button onclick="resetFilters()" class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition">Reset All</button>
                    </div>
                </div>
            </div>

            <div id="stabilization-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheet ‡∏¢‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (Work Order ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∂‡∏á‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <div class="card border-l-4 border-blue-500 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="metric-label text-blue-600">Total Jobs</div>
                            <div class="metric-value mt-1" id="kpi-jobs">0</div>
                            <div class="text-xs text-gray-400 mt-1">(Calculated)</div>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i class="fas fa-briefcase text-lg"></i></div>
                    </div>
                </div>
                <div class="card border-l-4 border-green-500 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="metric-label text-green-600">Total PBOQ</div>
                            <div class="metric-value mt-1 text-green-700" id="kpi-pboq">0</div>
                            <div class="text-xs text-gray-400 mt-1">THB</div>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg text-green-600"><i class="fas fa-coins text-lg"></i></div>
                    </div>
                </div>
                <div class="card border-l-4 border-teal-500 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="metric-label text-teal-600">Total FBOQ</div>
                            <div class="metric-value mt-1 text-teal-700" id="kpi-fboq">0</div>
                            <div class="text-xs text-gray-400 mt-1">THB</div>
                        </div>
                        <div class="p-2 bg-teal-50 rounded-lg text-teal-600"><i class="fas fa-money-bill-wave text-lg"></i></div>
                    </div>
                </div>
                <div class="card border-l-4 border-purple-500 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="metric-label text-purple-600">Work Order</div>
                            <div class="metric-value mt-1" id="kpi-wo">0</div>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600"><i class="fas fa-file-invoice text-lg"></i></div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-3">
                        <div class="bg-purple-500 h-1 rounded-full transition-all duration-1000" id="prog-wo" style="width: 0%"></div>
                    </div>
                </div>
                <div class="card border-l-4 border-yellow-500 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="metric-label text-yellow-600">PO No.</div>
                            <div class="metric-value mt-1" id="kpi-po">0</div>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded-lg text-yellow-600"><i class="fas fa-file-signature text-lg"></i></div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1 mt-3">
                        <div class="bg-yellow-500 h-1 rounded-full transition-all duration-1000" id="prog-po" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2"><span class="w-1 h-6 bg-blue-500 rounded-full"></span> 1. Jobs by Sub Region</h3>
                    <div id="chart-region" class="w-full h-80"></div>
                </div>
                <div class="card">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2"><span class="w-1 h-6 bg-indigo-500 rounded-full"></span> 2. Jobs by Project</h3>
                    <div id="chart-project" class="w-full h-80"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2"><span class="w-1 h-6 bg-purple-500 rounded-full"></span> 3. Project Status</h3>
                    <div id="chart-status" class="w-full h-80"></div>
                </div>
                <div class="card">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2"><span class="w-1 h-6 bg-green-500 rounded-full"></span> 6. PBOQ Distribution</h3>
                    <div id="chart-pboq" class="w-full h-80"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card border-t-4 border-t-red-400">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                        <h3 class="font-bold text-gray-800 text-lg">4. Missing Work Order</h3>
                        <span class="bg-red-100 text-red-600 text-xs px-3 py-1 rounded-full font-bold" id="count-missing-wo">0</span>
                    </div>
                    <div class="flex flex-col h-full">
                        <div id="chart-pie-wo" class="h-40 w-full mb-2"></div>
                        <div class="flex-1 overflow-hidden border border-gray-200 rounded-xl bg-white">
                            <div class="scrollable-table h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0">
                                        <tr><th class="px-4 py-3 font-semibold">CCT NO</th><th class="px-4 py-3 font-semibold">Project</th><th class="px-4 py-3 font-semibold">Status</th></tr>
                                    </thead>
                                    <tbody id="table-missing-wo" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-t-4 border-t-yellow-400">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                        <h3 class="font-bold text-gray-800 text-lg">5. Has WO, Waiting PO</h3>
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-3 py-1 rounded-full font-bold" id="count-missing-po">0</span>
                    </div>
                    <div class="flex flex-col h-full">
                        <div id="chart-pie-po" class="h-40 w-full mb-2"></div>
                        <div class="flex-1 overflow-hidden border border-gray-200 rounded-xl bg-white">
                            <div class="scrollable-table h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0">
                                        <tr><th class="px-4 py-3 font-semibold">CCT NO</th><th class="px-4 py-3 font-semibold">WO No.</th><th class="px-4 py-3 font-semibold text-right">PBOQ</th></tr>
                                    </thead>
                                    <tbody id="table-missing-po" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="debug-container">
                <h4 class="font-bold mb-2 text-red-600">üöß Debug Data (First 5 Rows) - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö</h4>
                <div class="overflow-x-auto">
                    <table class="debug-table">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>CCT_NO (0)</th>
                                <th>Region (2)</th>
                                <th>Project (4)</th>
                                <th>Status (5)</th>
                                <th>Work Order (6)</th>
                                <th>PO (7)</th>
                                <th>PBOQ (8)</th>
                                <th>FBOQ (9)</th>
                            </tr>
                        </thead>
                        <tbody id="debug-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="text-center text-xs text-gray-400 mt-12 pb-4">
                Powered by Project CCT Analytics Module | V42 Anti-Bounce Logic
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SHEET_ID = ""; 
        const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_QKLW_J1dfnepcwsdExV1aBiX3gc7voJC1Pckm5-jkyG1AEjfHEdFz9x2CCOPVEolqIAWPun7721c/pub?output=csv";
        const PROXY_URL = "https://corsproxy.io/?";
        const REFRESH_RATE = 20000; // Increase to 20s to give Google time to calc

        let rawData = [];
        let filteredData = [];
        let isUpdateInProgress = false;
        let sheetSummary = { jobs: 0 };
        
        // Anti-Bounce State
        let lastValidStats = { wo: 0, po: 0, jobs: 0 };
        let isFirstLoad = true;

        window.onload = () => {
            startTimeClock();
            fetchData();
            setInterval(fetchData, REFRESH_RATE);
        };

        function startTimeClock() {
            setInterval(() => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('th-TH');
                const dateStr = now.toLocaleDateString('th-TH');
                document.getElementById('current-time-display').innerText = `${dateStr} ${timeStr}`;
            }, 1000);
        }

        // File Inputs
        document.getElementById('csv-file-input').addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Processing File...";
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: (results) => successHandler(results, false, "Local File: " + file.name),
                error: (err) => alert("File Error: " + err.message)
            });
        }

        // Manual Paste
        function openPasteModal() { document.getElementById('paste-modal').style.display = 'flex'; }
        function closePasteModal() { document.getElementById('paste-modal').style.display = 'none'; }
        
        function processPasteData(force = false) {
            const text = document.getElementById('csv-paste-area').value;
            if(!text) return;
            Papa.parse(text, {
                header: false,
                skipEmptyLines: true,
                complete: (results) => {
                    closePasteModal();
                    successHandler(results, false, "Manual Paste", force);
                }
            });
        }

        function manualRefresh() {
            fetchData();
        }

        function fetchData() {
            if (isUpdateInProgress) return;
            isUpdateInProgress = true;
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');

            const bustCacheUrl = GVIZ_URL + "&_t=" + new Date().getTime();
            const finalUrl = PROXY_URL + encodeURIComponent(bustCacheUrl);

            Papa.parse(finalUrl, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: (res) => {
                    successHandler(res, false, "Online (GVIZ)");
                    isUpdateInProgress = false;
                },
                error: (err) => {
                    console.warn("Proxy failed, trying direct...");
                    const directUrl = GVIZ_URL; 
                    Papa.parse(PROXY_URL + encodeURIComponent(directUrl), {
                        download: true,
                        header: false,
                        skipEmptyLines: true,
                        complete: (res) => {
                            successHandler(res, false, "Online (Export)");
                            isUpdateInProgress = false;
                        },
                        error: (err) => {
                            errorHandler(err, false);
                            isUpdateInProgress = false;
                        }
                    });
                }
            });
        }

        function successHandler(results, isBackground, sourceName, force = false) {
            if (results && results.data && results.data.length > 0) {
                const success = processData(results.data, force);
                if (success) {
                    if(!isBackground) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-app').classList.remove('hidden');
                        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
                    }
                    const btn = document.getElementById('refresh-btn');
                    if(btn) btn.classList.remove('animate-spin');
                    
                    document.getElementById('status-indicator').innerHTML = `<span class="online-dot"></span> Online`;
                    const now = new Date();
                    document.getElementById('last-updated').innerText = now.toLocaleTimeString('th-TH');
                }
            } else {
                if(!isBackground) errorHandler("Empty Data", isBackground);
            }
        }

        function errorHandler(err, isBackground) {
            console.error(err);
            const btn = document.getElementById('refresh-btn');
            if(btn) btn.classList.remove('animate-spin');
            
            if (!isBackground) {
                document.getElementById('loading-text').innerText = "Connection Failed.";
                document.getElementById('fallback-ui').classList.remove('hidden');
                document.querySelector('.loader').style.display = 'none';
            }
        }

        function processData(rows, force = false) {
            const headerIdx = 1;
            if (rows.length <= headerIdx + 1) return false;

            if (rows[0] && rows[0].length > 4) {
                sheetSummary.jobs = parseInt(rows[0][1].replace(/,/g, '')) || 0; 
                document.getElementById('sheet-jobs-display').innerText = sheetSummary.jobs.toLocaleString();
            }

            // Fixed Column Map
            const colMap = { id: 0, project: 4, region: 2, status: 5, wo: 6, po: 7, pboq: 8, fboq: 9 };

            // 1. Extract Data
            const tempRawData = rows.slice(headerIdx + 1).map(row => {
                const id = row[colMap.id];
                if(!id || id.trim() === '') return null;
                return {
                    id: id,
                    project: row[colMap.project] ? row[colMap.project].trim() : 'Unknown',
                    region: row[colMap.region] || 'Unknown',
                    status: row[colMap.status] || 'Unknown',
                    wo: row[colMap.wo] ? row[colMap.wo].trim() : '',
                    po: row[colMap.po] ? row[colMap.po].trim() : '',
                    pboq: parseMoney(row[colMap.pboq]),
                    fboq: parseMoney(row[colMap.fboq])
                };
            }).filter(x => x);

            // 2. Anti-Bounce Validation Logic
            const newTotalJobs = tempRawData.length;
            const newTotalWO = tempRawData.filter(d => d.wo).length;

            if (!isFirstLoad && !force) {
                // Heuristic: If Total Jobs is STABLE (approx same), but WO count DROPS massively (>20% drop)
                // This means Google sent a sheet where Formulas haven't loaded yet.
                const isJobsStable = Math.abs(newTotalJobs - lastValidStats.jobs) < 50; 
                const isWODropped = newTotalWO < (lastValidStats.wo * 0.8); // Drop by more than 20%

                if (isJobsStable && isWODropped) {
                    console.warn(`Anti-Bounce Triggered! Jobs: ${newTotalJobs}, WO: ${newTotalWO} (Prev WO: ${lastValidStats.wo}). Rejecting update.`);
                    document.getElementById('stabilization-warning').classList.remove('hidden');
                    return true; // Return true to keep UI alive, but don't update data
                }
            }

            // If valid, accept new data
            rawData = tempRawData;
            lastValidStats = { wo: newTotalWO, jobs: newTotalJobs };
            isFirstLoad = false;
            document.getElementById('stabilization-warning').classList.add('hidden');

            updateDebugTable(rawData.slice(0, 5));
            setupFilters();
            applyFilters();
            return true;
        }

        function updateDebugTable(sampleData) {
            const tbody = document.getElementById('debug-table-body');
            tbody.innerHTML = sampleData.map((d, i) => `
                <tr class="debug-row">
                    <td>${i + 1}</td>
                    <td>${d.id}</td>
                    <td>${d.region}</td>
                    <td>${d.project}</td>
                    <td>${d.status}</td>
                    <td>${d.wo}</td>
                    <td>${d.po}</td>
                    <td>${d.pboq.toLocaleString()}</td>
                    <td>${d.fboq.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function parseMoney(val) {
            if (!val) return 0;
            const clean = val.toString().replace(/,/g, '').replace(/[^\d.-]/g, '');
            return parseFloat(clean) || 0;
        }

        function setupFilters() {
            if(document.getElementById('filter-project').innerHTML !== "") return;
            const projects = [...new Set(rawData.map(d => d.project))].filter(p => p !== 'Unknown' && p !== '').sort();
            const regions = [...new Set(rawData.map(d => d.region))].sort();

            const createCB = (list) => list.map(item => 
                `<label class="flex items-center space-x-2 py-1.5 cursor-pointer hover:bg-gray-50 rounded px-1 transition"><input type="checkbox" value="${item}" checked class="form-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"><span class="text-gray-700 truncate text-sm select-none">${item}</span></label>`
            ).join('');

            document.getElementById('filter-project').innerHTML = createCB(projects);
            document.getElementById('filter-region').innerHTML = createCB(regions);
            document.querySelectorAll('.form-checkbox').forEach(cb => cb.addEventListener('change', applyFilters));
        }

        function resetFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            applyFilters();
        }

        function applyFilters() {
            const sProj = new Set();
            const sReg = new Set();
            document.querySelectorAll('#filter-project input:checked').forEach(c => sProj.add(c.value));
            document.querySelectorAll('#filter-region input:checked').forEach(c => sReg.add(c.value));
            filteredData = rawData.filter(d => sProj.has(d.project) && sReg.has(d.region));
            renderDashboard();
        }

        function renderDashboard() {
            const activeData = filteredData.filter(d => d.project !== 'Unknown' && d.project.trim() !== '');
            const total = activeData.length;
            const pboq = activeData.reduce((sum, d) => sum + d.pboq, 0);
            const fboq = activeData.reduce((sum, d) => sum + d.fboq, 0);
            const hasWO = activeData.filter(d => d.wo).length;
            const hasPO = activeData.filter(d => d.po).length; 

            updateKPI("kpi-jobs", total);
            updateKPI("kpi-pboq", pboq);
            updateKPI("kpi-fboq", fboq);
            updateKPI("kpi-wo", hasWO);
            updateKPI("kpi-po", hasPO);

            // Update Integrity Monitor
            document.getElementById('calc-jobs-display').innerText = total.toLocaleString();
            const diff = sheetSummary.jobs - total;
            const diffEl = document.getElementById('diff-jobs-display');
            diffEl.innerText = diff > 0 ? `-${diff}` : (diff < 0 ? `+${Math.abs(diff)}` : "0");
            
            const statusIcon = document.getElementById('data-status-icon');
            if (sheetSummary.jobs > 0 && Math.abs(diff) > 5) {
                statusIcon.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
                statusIcon.className = "text-2xl text-yellow-500 pl-4 border-l border-gray-200 self-center";
                diffEl.className = "font-bold text-yellow-500 text-lg";
            } else {
                statusIcon.innerHTML = `<i class="fas fa-check-circle"></i>`;
                statusIcon.className = "text-2xl text-green-500 pl-4 border-l border-gray-200 self-center";
                diffEl.className = "font-bold text-green-500 text-lg";
            }

            document.getElementById('prog-wo').style.width = total ? `${(hasWO/total)*100}%` : '0%';
            document.getElementById('prog-po').style.width = total ? `${(hasPO/total)*100}%` : '0%';

            const layout = { 
                margin: { t: 20, b: 30, l: 30, r: 10 }, 
                font: { family: 'Sarabun' },
                paper_bgcolor:'rgba(0,0,0,0)',
                plot_bgcolor:'rgba(0,0,0,0)'
            };
            const config = { displayModeBar: false, responsive: true };

            // Chart 1: Region (Vertical)
            const rData = countBy(activeData, 'region');
            Plotly.react('chart-region', [{x: Object.keys(rData), y: Object.values(rData), type: 'bar', marker: {color: '#3b82f6'}}], layout, config);

            // Chart 2: Project (Horizontal - Sorted & Fixed Axis)
            const pData = countBy(activeData, 'project');
            const pEntries = Object.entries(pData).sort((a, b) => a[1] - b[1]);
            const pKeys = pEntries.map(e => e[0]);
            const pValues = pEntries.map(e => e[1]);

            Plotly.react('chart-project', [{
                y: pKeys,
                x: pValues,
                type: 'bar',
                orientation: 'h',
                text: pValues.map(String),
                textposition: 'auto',
                marker: {color: '#6366f1'}
            }], {
                ...layout,
                margin:{l:120, r:20, t:20, b:30},
                yaxis: {automargin: true},
                xaxis: {type: 'linear'} 
            }, config);

            // Chart 3: Status
            const statuses = [...new Set(activeData.map(d => d.status))].sort();
            const traces = statuses.map(s => ({
                name: s,
                type: 'bar',
                x: Object.keys(pData), 
                y: Object.keys(pData).map(p => activeData.filter(d => d.project === p && d.status === s).length)
            }));
            Plotly.react('chart-status', traces, {...layout, barmode: 'stack', showlegend: true, legend: {orientation:'h', y:-0.15}}, config);

            // Chart 6: PBOQ Pie
            const pbData = {};
            activeData.forEach(d => pbData[d.project] = (pbData[d.project]||0)+d.pboq);
            const pColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
            Plotly.react('chart-pboq', [{labels: Object.keys(pbData), values: Object.values(pbData), type: 'pie', hole: 0.5, textinfo: 'label+percent', marker: { colors: pColors }}], {...layout, showlegend: true, margin: {t:0,b:0,l:0,r:0}}, config);

            // Tables
            const missingWO = activeData.filter(d => !d.wo);
            document.getElementById('count-missing-wo').innerText = missingWO.length;
            Plotly.react('chart-pie-wo', [{labels: ['Has WO', 'Missing'], values: [hasWO, missingWO.length], type: 'pie', hole: 0.65, marker: {colors: ['#22c55e', '#ef4444']}, textinfo: 'percent'}], {...layout, margin:{t:0,b:0,l:0,r:0}, showlegend: false}, config);
            renderTable('table-missing-wo', missingWO, ['id', 'project', 'status']);

            const missingPO = activeData.filter(d => d.wo && !d.po);
            document.getElementById('count-missing-po').innerText = missingPO.length;
            Plotly.react('chart-pie-po', [{labels: ['Has PO', 'Pending'], values: [hasPO, missingPO.length], type: 'pie', hole: 0.65, marker: {colors: ['#eab308', '#f3f4f6']}, textinfo: 'percent'}], {...layout, margin:{t:0,b:0,l:0,r:0}, showlegend: false}, config);
            renderTable('table-missing-po', missingPO, ['id', 'wo', 'pboq']);
        }

        function countBy(data, key) {
            const counts = {};
            data.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + 1);
            return counts;
        }

        function updateKPI(id, val) {
            document.getElementById(id).innerText = val.toLocaleString();
        }

        function renderTable(id, data, cols) {
            const container = document.getElementById(id);
            if (data.length === 0) {
                container.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-gray-400">‚úÖ All Good!</td></tr>`;
                return;
            }
            container.innerHTML = data.slice(0, 50).map(row => `
                <tr class="bg-white border-b hover:bg-gray-50 text-xs md:text-sm">
                    <td class="px-4 py-2 font-medium text-gray-900">${row.id}</td>
                    <td class="px-4 py-2 text-gray-500 truncate max-w-[100px]">${cols[1]==='wo' ? (row.wo||'-') : row.project}</td>
                    <td class="px-4 py-2 text-right">${cols[2]==='pboq' ? row.pboq.toLocaleString() : `<span class="px-2 py-1 rounded bg-gray-100">${row.status}</span>`}</td>
                </tr>
            `).join('');
        }

        window.onresize = () => renderDashboard();
    </script>
</body>
</html>