<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project CCT Dashboard (Cloud Dancer Edition V86)</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        'cloud-bg': '#F5F4F1', 
                        'cloud-surface': '#FFFFFF',
                        'cloud-border': '#E5E7EB',
                        'primary': '#374151',
                        'accent': '#6B7280',
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'float': '0 20px 40px -5px rgba(0,0,0,0.08)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #F5F4F1;
            color: #374151; 
            -webkit-font-smoothing: antialiased;
        }
        
        .glass-card {
            background: #FFFFFF;
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.06);
            border-color: #818CF8;
        }

        .clickable-card { cursor: pointer; }
        .clickable-card:active { transform: scale(0.98); }
        
        /* Badges - Responsive Size */
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 700; white-space: nowrap; letter-spacing: 0.025em; }
        @media (min-width: 768px) {
            .badge { padding: 0.25rem 0.75rem; font-size: 0.75rem; }
        }
        
        .badge-completed { background-color: #DCFCE7; color: #166534; }
        .badge-pass-gate { background-color: #CCFBF1; color: #0F766E; }
        .badge-lay-ofc { background-color: #E0F2FE; color: #0369A1; }
        .badge-assign { background-color: #E0E7FF; color: #3730A3; }
        .badge-surveyed { background-color: #F3E8FF; color: #6B21A8; }
        .badge-wait-survey { background-color: #F3F4F6; color: #4B5563; }
        .badge-wait-gate { background-color: #FEF9C3; color: #854D0E; }
        .badge-wait-cut { background-color: #FFEDD5; color: #9A3412; }
        .badge-re-gate { background-color: #FFE4E6; color: #BE123C; }
        .badge-reject { background-color: #FCE7F3; color: #9D174D; }
        .badge-cancel { background-color: #FEF2F2; color: #991B1B; }
        .badge-gray { background-color: #F9FAFB; color: #6B7280; border: 1px solid #E5E7EB; }

        .loader { width: 48px; height: 48px; border: 4px solid #E5E7EB; border-bottom-color: #4B5563; border-radius: 50%; animation: spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); z-index: 100; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease-out; }
        
        .filter-input {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            padding: 0.6rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem; 
            width: 100%;
            transition: all 0.2s;
        }
        .filter-input:focus {
            border-color: #9CA3AF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.1);
        }

        /* Detail Table - Responsive */
        .detail-table th { font-weight: 600; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; background: #F9FAFB; padding: 10px; white-space: nowrap; cursor: pointer; user-select: none; }
        .detail-table th:hover { background: #F3F4F6; }
        .detail-table td { font-size: 0.85rem; padding: 10px; border-bottom: 1px solid #F3F4F6; color: #374151; white-space: nowrap; }
        @media (min-width: 768px) {
            .detail-table th { font-size: 0.85rem; padding: 14px; }
            .detail-table td { font-size: 0.95rem; padding: 14px; }
        }
        .detail-table tr:last-child td { border-bottom: none; }

        /* Tabs */
        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #6B7280;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-tab.active {
            background-color: #FFFFFF;
            color: #374151;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        /* Pagination */
        .pagination-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            background: white;
            border: 1px solid #E5E7EB;
            color: #4B5563;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) { background: #F3F4F6; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background: #374151; color: white; border-color: #374151; }
    </style>
</head>
<body class="selection:bg-gray-200">

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-[#F5F4F1] z-50 flex flex-col justify-center items-center transition-opacity duration-300">
        <div class="loader mb-6"></div>
        <h2 class="text-2xl md:text-3xl font-light text-gray-700 tracking-wide text-center">Project CCT</h2>
        <p class="text-sm md:text-base text-gray-400 mt-2">Dashboard V86 Initializing...</p>
        <div id="fallback-ui" class="hidden mt-8 flex flex-col items-center gap-3 animate-fade-in">
            <button onclick="openPasteModal()" class="px-6 py-2 md:px-8 md:py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-50 transition text-sm md:text-base">Manual CSV Input</button>
        </div>
    </div>

    <!-- Paste Modal -->
    <div id="paste-modal" class="modal-overlay px-4">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-2xl border border-gray-100">
            <h3 class="text-xl md:text-2xl font-bold mb-4 text-gray-800">Import Data</h3>
            <textarea id="csv-paste-area" class="w-full h-48 md:h-64 border border-gray-200 rounded-xl p-4 text-xs md:text-sm font-mono mb-6 focus:ring-2 focus:ring-gray-100 outline-none bg-gray-50 resize-none" placeholder="Paste your CSV content here..."></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closePasteModal()" class="px-5 py-2 md:px-6 md:py-2.5 text-gray-500 hover:bg-gray-50 rounded-xl transition font-medium text-sm md:text-base">Cancel</button>
                <button onclick="processPasteData()" class="px-5 py-2 md:px-6 md:py-2.5 bg-gray-800 text-white rounded-xl hover:bg-gray-700 transition font-medium shadow-lg shadow-gray-200 text-sm md:text-base">Process Data</button>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.25)] w-full max-w-6xl h-[90vh] md:max-h-[90vh] flex flex-col mx-0 md:mx-4 border border-gray-100 animate-slide-up mt-auto md:mt-0">
            <div class="p-6 md:p-8 border-b border-gray-100 bg-gray-50/50 rounded-t-3xl">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-gray-800 text-2xl md:text-3xl" id="modal-project-name">Project Name</h3>
                        <div class="flex flex-col md:flex-row gap-2 md:gap-6 mt-2 md:mt-3 text-sm md:text-base text-gray-500">
                            <span id="modal-total-jobs" class="flex items-center gap-2"><i class="fas fa-briefcase"></i> 0 Jobs</span>
                            <span id="modal-total-pboq" class="flex items-center gap-2"><i class="fas fa-coins"></i> 0 THB</span>
                        </div>
                    </div>
                    <button onclick="closeProjectModal()" class="h-8 w-8 md:h-10 md:w-10 rounded-full hover:bg-gray-200 flex items-center justify-center text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-lg md:text-xl"></i></button>
                </div>
                <!-- Mini Progress Bar in Modal -->
                <div class="mt-6">
                    <div class="flex justify-between text-xs text-gray-400 mb-1 uppercase font-bold tracking-wider">
                        <span>Project Completion</span>
                        <span id="modal-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                        <div id="modal-progress-bar" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 md:p-8 overflow-y-auto custom-scroll overflow-x-auto bg-white">
                <table class="w-full detail-table text-left">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Status</th>
                            <th>Work Order</th>
                            <th>PO Number</th>
                            <th class="text-right">PBOQ</th>
                            <th class="text-right">FBOQ</th>
                        </tr>
                    </thead>
                    <tbody id="modal-project-table">
                        <!-- Content Injected -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 md:p-6 border-t border-gray-100 bg-gray-50/30 md:rounded-b-3xl flex justify-end pb-8 md:pb-6">
                <button onclick="closeProjectModal()" class="px-6 py-2 md:px-8 md:py-2.5 text-sm md:text-base text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-app" class="hidden min-h-screen pb-12">
        <!-- Navbar -->
        <nav class="sticky top-0 z-30 bg-[#F5F4F1]/95 backdrop-blur-xl border-b border-gray-200/50 shadow-sm md:shadow-none">
            <div class="max-w-[95%] mx-auto px-4 md:px-6">
                <div class="flex flex-col md:flex-row justify-between py-4 md:h-24 md:items-center gap-4 md:gap-0">
                    <div class="flex items-center gap-4 md:gap-6">
                        <!-- Logo Section (Static) -->
                        <div class="h-10 w-10 md:h-14 md:w-14 bg-white p-1 rounded-xl md:rounded-2xl shadow-[0_2px_10px_rgba(0,0,0,0.05)] border border-gray-100 flex items-center justify-center overflow-hidden relative">
                            <img id="company-logo" src="" alt="CCT" class="h-full w-full object-contain hidden" referrerpolicy="no-referrer">
                            <div id="logo-fallback" class="flex text-gray-300 font-bold text-[10px] md:text-sm flex-col items-center justify-center h-full w-full bg-gray-50">CCT</div>
                        </div>
                        
                        <div>
                            <h1 class="font-bold text-lg md:text-2xl text-gray-800 tracking-tight leading-tight">Project CCT</h1>
                            <div class="text-xs md:text-sm text-gray-400 font-medium tracking-wide">DASHBOARD V86</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between md:justify-end gap-4 md:gap-6 w-full md:w-auto border-t md:border-t-0 border-gray-200/50 pt-3 md:pt-0">
                         <!-- Current Time & Sync Status -->
                         <div class="flex flex-col md:items-end">
                            <div id="clock-display" class="text-lg md:text-2xl font-bold text-gray-700 leading-none tracking-tight font-mono">00:00:00</div>
                            <div class="flex items-center gap-1.5 md:gap-2 mt-1">
                                <span class="relative flex h-2 w-2 md:h-2.5 md:w-2.5">
                                  <span id="sync-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                  <span id="sync-dot" class="relative inline-flex rounded-full h-2 w-2 md:h-2.5 md:w-2.5 bg-green-500"></span>
                                </span>
                                <span class="text-[10px] md:text-xs text-gray-400 font-medium uppercase tracking-wide">Synced: <span id="last-updated" class="font-bold text-gray-500">--:--</span></span>
                            </div>
                        </div>

                        <button onclick="exportToCSV()" class="bg-white border border-gray-200 text-gray-600 h-10 w-10 md:h-12 md:w-12 flex items-center justify-center rounded-xl hover:bg-gray-50 hover:text-gray-800 transition shadow-sm" title="Export Current View (CSV)">
                            <i class="fas fa-download text-sm md:text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-[95%] mx-auto px-4 md:px-6 py-6 md:py-8 space-y-6 animate-slide-up">
            
            <!-- Filters Bar & View Switcher -->
            <div class="glass-card p-2 md:p-3 z-20 sticky top-[80px] md:top-28 md:static">
                <div class="flex flex-col xl:flex-row gap-4 justify-between">
                    <!-- View Switcher -->
                    <div class="bg-gray-100/50 p-1 rounded-xl flex gap-1 w-full xl:w-auto shrink-0">
                        <div class="nav-tab active flex-1 text-center xl:w-36" onclick="switchView('dashboard')" id="tab-dashboard">
                            <i class="fas fa-chart-pie mr-2"></i>Dashboard
                        </div>
                        <div class="nav-tab flex-1 text-center xl:w-36" onclick="switchView('datalist')" id="tab-datalist">
                            <i class="fas fa-table mr-2"></i>Data List
                        </div>
                    </div>

                    <!-- Search & Filters -->
                    <div class="flex flex-col md:flex-row gap-3 w-full items-center p-2">
                         <div class="relative w-full">
                            <i class="fas fa-search absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm md:text-base"></i>
                            <input type="text" id="search-input" oninput="filterData()" placeholder="Search ID, Project, or WO..." class="filter-input pl-10 md:pl-12">
                        </div>
                        <div class="flex gap-3 w-full md:w-auto shrink-0">
                            <select id="region-filter" onchange="filterData()" class="filter-input w-1/2 md:w-48 appearance-none cursor-pointer text-gray-600 font-medium">
                                <option value="all">All Regions</option>
                            </select>
                            <select id="status-filter" onchange="filterData()" class="filter-input w-1/2 md:w-56 appearance-none cursor-pointer text-gray-600 font-medium">
                                <option value="all">All Statuses</option>
                            </select>
                        </div>
                         <button onclick="resetFilters()" class="text-sm text-red-500 hover:underline hidden whitespace-nowrap px-2" id="reset-filter-btn">Reset</button>
                    </div>
                </div>
            </div>

            <div id="stabilization-warning" class="hidden bg-amber-50 border border-amber-100 text-amber-700 px-4 py-3 md:px-8 md:py-5 rounded-2xl flex items-center md:items-start gap-4 md:gap-5 shadow-sm">
                <div class="bg-amber-100 p-2 md:p-3 rounded-xl text-amber-600"><i class="fas fa-sync fa-spin text-lg md:text-xl"></i></div>
                <div>
                    <h4 class="font-bold text-sm md:text-lg">Synchronizing Data</h4>
                    <p class="text-xs md:text-base text-amber-600/80 mt-0.5 md:mt-1">Fetching latest updates from source. Please wait a moment.</p>
                </div>
            </div>

            <!-- VIEW 1: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6 animate-fade-in">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6">
                    <div class="glass-card p-5 md:p-6 group hover:bg-white/80">
                        <div class="flex justify-between items-start">
                            <div class="text-xs md:text-sm text-gray-400 uppercase font-bold tracking-wider">Total Jobs</div>
                            <div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 group-hover:scale-110 transition"><i class="fas fa-briefcase text-xs md:text-sm"></i></div>
                        </div>
                        <div class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-800 mt-3 tracking-tight" id="kpi-jobs">0</div>
                    </div>
                    <div class="glass-card p-5 md:p-6 group hover:bg-white/80">
                        <div class="flex justify-between items-start">
                            <div class="text-xs md:text-sm text-gray-400 uppercase font-bold tracking-wider">Work Order</div>
                            <div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center text-green-500 group-hover:scale-110 transition"><i class="fas fa-file-contract text-xs md:text-sm"></i></div>
                        </div>
                        <div class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-800 mt-3 tracking-tight" id="kpi-wo">0</div>
                        <div class="w-full bg-gray-100 h-2 mt-4 rounded-full overflow-hidden"><div id="prog-wo" class="bg-green-500 h-full rounded-full transition-all duration-1000" style="width:0%"></div></div>
                    </div>
                    <div class="glass-card p-5 md:p-6 group hover:bg-white/80">
                        <div class="flex justify-between items-start">
                            <div class="text-xs md:text-sm text-gray-400 uppercase font-bold tracking-wider">PO</div>
                            <div class="h-8 w-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 group-hover:scale-110 transition"><i class="fas fa-file-invoice-dollar text-xs md:text-sm"></i></div>
                        </div>
                        <div class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-800 mt-3 tracking-tight" id="kpi-po">0</div>
                        <div class="w-full bg-gray-100 h-2 mt-4 rounded-full overflow-hidden"><div id="prog-po" class="bg-purple-500 h-full rounded-full transition-all duration-1000" style="width:0%"></div></div>
                    </div>
                    <!-- Financials -->
                    <div class="glass-card p-5 md:p-6 col-span-1 sm:col-span-2 md:col-span-3 lg:col-span-2 flex flex-col justify-center relative overflow-hidden bg-gradient-to-br from-white to-gray-50">
                        <div class="flex items-center justify-between px-2 md:px-6 relative z-10">
                            <div class="text-center w-1/2 border-r border-gray-100">
                                <div class="text-xs md:text-sm text-gray-400 uppercase font-bold tracking-wider mb-2">PBOQ</div>
                                <div class="text-2xl md:text-3xl xl:text-4xl font-bold text-gray-700" id="kpi-pboq">0</div>
                                <div class="text-[10px] md:text-xs text-gray-400 font-mono mt-1">THB</div>
                            </div>
                            <div class="text-center w-1/2">
                                <div class="text-xs md:text-sm text-gray-400 uppercase font-bold tracking-wider mb-2">FBOQ</div>
                                <div class="text-2xl md:text-3xl xl:text-4xl font-bold text-gray-800" id="kpi-fboq">0</div>
                                <div class="text-[10px] md:text-xs text-gray-400 font-mono mt-1">THB</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="glass-card p-5 md:p-6 lg:col-span-2">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-3"><i class="fas fa-map-marker-alt text-indigo-400"></i> Jobs by Region</h3>
                        </div>
                        <div id="chart-region" class="w-full h-72 md:h-96"></div>
                    </div>
                    <!-- New Chart: Global Status -->
                    <div class="glass-card p-5 md:p-6">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-3"><i class="fas fa-chart-pie text-pink-400"></i> Overall Status</h3>
                        </div>
                        <div id="chart-status-global" class="w-full h-72 md:h-96"></div>
                    </div>
                </div>

                <div class="glass-card p-5 md:p-6">
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-3"><i class="fas fa-chart-bar text-teal-400"></i> Projects Overview</h3>
                    </div>
                    <div id="chart-project-global" class="w-full h-72 md:h-96"></div>
                </div>

                <!-- Project Grid -->
                <div>
                    <div class="flex justify-between items-end mb-4 md:mb-6">
                        <h3 class="font-bold text-2xl md:text-3xl text-gray-700 flex items-center gap-2 md:gap-4">
                            <div class="h-8 md:h-10 w-1.5 md:w-2 bg-indigo-600 rounded-full"></div>
                            Project Status
                            <span class="text-sm md:text-base text-gray-400 font-normal ml-1 md:ml-2 hidden sm:inline">(Click for details)</span>
                        </h3>
                        <span class="text-sm md:text-base font-semibold bg-white px-3 py-1 md:px-5 md:py-2 rounded-xl text-gray-500 border border-gray-200 shadow-sm" id="project-count">0 Projects</span>
                    </div>
                    <div id="project-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <!-- Cards injected here -->
                    </div>
                </div>

                <!-- Action Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="glass-card p-0 overflow-hidden flex flex-col h-[450px] md:h-[550px]">
                        <div class="p-5 md:p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
                            <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-2 md:gap-3"><i class="fas fa-exclamation-circle text-amber-500"></i> Missing Work Order</h3>
                            <span class="bg-white text-gray-600 text-xs md:text-sm px-2.5 py-1 md:px-3 md:py-1 rounded-full font-bold border border-gray-200 shadow-sm" id="count-missing-wo">0</span>
                        </div>
                        <div class="overflow-y-auto flex-grow custom-scroll overflow-x-auto">
                            <table class="w-full text-sm md:text-base min-w-[400px]">
                                <thead class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 text-gray-500 border-b border-gray-100 font-semibold uppercase tracking-wider text-xs md:text-sm">
                                    <tr><th class="py-3 pl-4 md:py-4 md:pl-6 text-left font-medium">Job ID</th><th class="py-3 md:py-4 text-left font-medium">Project</th><th class="py-3 pr-4 md:py-4 md:pr-6 text-right font-medium">Current Status</th></tr>
                                </thead>
                                <tbody id="table-missing-wo" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="glass-card p-0 overflow-hidden flex flex-col h-[450px] md:h-[550px]">
                        <div class="p-5 md:p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
                            <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-2 md:gap-3"><i class="fas fa-clock text-blue-500"></i> Pending PO</h3>
                            <span class="bg-white text-gray-600 text-xs md:text-sm px-2.5 py-1 md:px-3 md:py-1 rounded-full font-bold border border-gray-200 shadow-sm" id="count-missing-po">0</span>
                        </div>
                        <div class="overflow-y-auto flex-grow custom-scroll overflow-x-auto">
                            <table class="w-full text-sm md:text-base min-w-[400px]">
                                <thead class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 text-gray-500 border-b border-gray-100 font-semibold uppercase tracking-wider text-xs md:text-sm">
                                    <tr><th class="py-3 pl-4 md:py-4 md:pl-6 text-left font-medium">Job ID</th><th class="py-3 md:py-4 text-left font-medium">Work Order</th><th class="py-3 pr-4 md:py-4 md:pr-6 text-right font-medium">PBOQ Value</th></tr>
                                </thead>
                                <tbody id="table-missing-po" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: DATA LIST (New) -->
            <div id="view-datalist" class="hidden animate-fade-in space-y-6">
                <div class="glass-card flex flex-col h-[80vh]">
                    <div class="p-5 md:p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30 rounded-t-2xl">
                         <h3 class="font-bold text-lg md:text-xl text-gray-700 flex items-center gap-3"><i class="fas fa-database text-gray-400"></i> All Data Explorer</h3>
                         <span id="datalist-count" class="text-sm font-semibold text-gray-500 bg-white px-3 py-1 rounded-lg border border-gray-200">0 Records</span>
                    </div>
                    <div class="overflow-auto custom-scroll flex-grow p-4">
                        <table class="w-full detail-table text-left">
                            <thead class="sticky top-0 bg-white z-10 shadow-sm">
                                <tr>
                                    <th onclick="sortList('id')">Job ID <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th onclick="sortList('project')">Project <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th onclick="sortList('region')">Region <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th onclick="sortList('status')">Status <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th onclick="sortList('wo')">WO <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th onclick="sortList('po')">PO <i class="fas fa-sort text-xs ml-1"></i></th>
                                    <th class="text-right" onclick="sortList('pboq')">PBOQ <i class="fas fa-sort text-xs ml-1"></i></th>
                                </tr>
                            </thead>
                            <tbody id="full-data-table-body">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-100 bg-gray-50/50 rounded-b-2xl flex justify-between items-center">
                        <button onclick="prevPage()" id="btn-prev" class="pagination-btn"><i class="fas fa-chevron-left"></i> Prev</button>
                        <span id="page-info" class="text-sm font-medium text-gray-600">Page 1 of 1</span>
                        <button onclick="nextPage()" id="btn-next" class="pagination-btn">Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="text-center py-6 md:py-10 border-t border-gray-200/50 mt-6 md:mt-8 pb-20 md:pb-6">
                <p class="text-[10px] md:text-xs text-gray-300 font-medium tracking-[0.2em]">CLOUD DANCER EDITION V86 &bull; PROJECT CCT</p>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_QKLW_J1dfnepcwsdExV1aBiX3gc7voJC1Pckm5-jkyG1AEjfHEdFz9x2CCOPVEolqIAWPun7721c/pub?output=csv";
        const PROXY_URL = "https://corsproxy.io/?";
        const REFRESH_RATE = 30000;

        // --- USER CONFIG: Update your LOGO Base64 string here ---
        const LOGO_BASE64 = ""; 

        let rawData = [];
        let currentData = [];
        let isUpdateInProgress = false;
        let lastValidStats = { wo: 0, po: 0, jobs: 0 };
        let isFirstLoad = true;

        // Pagination State
        let currentPage = 1;
        const rowsPerPage = 50;
        let sortCol = 'id';
        let sortAsc = true;

        window.onload = () => { 
            if (LOGO_BASE64) applyLogo(LOGO_BASE64);
            fetchData(); 
            setInterval(fetchData, REFRESH_RATE);
            startClock();
        };
        
        function startClock() {
            const clock = document.getElementById('clock-display');
            setInterval(() => {
                const now = new Date();
                clock.innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            }, 1000);
        }
        
        function applyLogo(src) {
            const img = document.getElementById('company-logo');
            const fallback = document.getElementById('logo-fallback');
            img.src = src; img.classList.remove('hidden'); img.style.display = 'block';
            fallback.classList.add('hidden'); fallback.classList.remove('flex');
        }

        function switchView(viewName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${viewName}`).classList.add('active');
            
            if(viewName === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('view-datalist').classList.add('hidden');
            } else {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-datalist').classList.remove('hidden');
                renderDataTable(); // Render table when tab is opened
            }
        }

        function fetchData() {
            if (isUpdateInProgress) return;
            isUpdateInProgress = true;
            
            // Set Sync Status to "Syncing..." (Yellow/Pulse)
            document.getElementById('sync-dot').classList.remove('bg-green-500', 'bg-red-500');
            document.getElementById('sync-dot').classList.add('bg-yellow-400');
            document.getElementById('sync-ping').classList.remove('bg-green-400', 'bg-red-400');
            document.getElementById('sync-ping').classList.add('bg-yellow-400');

            const url = PROXY_URL + encodeURIComponent(GVIZ_URL + "&_t=" + Date.now());
            Papa.parse(url, {
                download: true, header: false, skipEmptyLines: true,
                complete: (res) => { 
                    processData(res.data); 
                    isUpdateInProgress = false;
                    // Success Status
                    document.getElementById('sync-dot').classList.remove('bg-yellow-400', 'bg-red-500');
                    document.getElementById('sync-dot').classList.add('bg-green-500');
                    document.getElementById('sync-ping').classList.remove('bg-yellow-400', 'bg-red-400');
                    document.getElementById('sync-ping').classList.add('bg-green-400');
                },
                error: () => { 
                    isUpdateInProgress = false; 
                    document.getElementById('fallback-ui').classList.remove('hidden');
                    // Error Status
                    document.getElementById('sync-dot').classList.remove('bg-yellow-400', 'bg-green-500');
                    document.getElementById('sync-dot').classList.add('bg-red-500');
                    document.getElementById('sync-ping').classList.remove('bg-yellow-400', 'bg-green-400');
                    document.getElementById('sync-ping').classList.add('bg-red-400');
                }
            });
        }

        function processData(rows) {
            if (!rows || rows.length < 2) return;
            let headerIdx = rows.findIndex(row => row.some(cell => cell && cell.toString().includes("CCT_NO")));
            if (headerIdx === -1) headerIdx = 1;
            const colMap = { id: 0, project: 4, region: 2, status: 5, wo: 6, po: 7, pboq: 8, fboq: 9 };
            
            const clean = (val) => (val && val.trim() !== '-' && val.trim().toLowerCase() !== 'n/a' && val.trim().toLowerCase() !== 'null') ? val.trim() : '';
            
            const data = rows.slice(headerIdx + 1).map(r => {
                const id = r[colMap.id];
                const proj = r[colMap.project] ? r[colMap.project].trim() : 'Unknown';
                if (!id || !id.trim() || proj === 'Unknown') return null;
                return {
                    id: id, project: proj, region: r[colMap.region] || '-', status: r[colMap.status] || '-',
                    wo: clean(r[colMap.wo]), 
                    po: clean(r[colMap.po]),
                    pboq: parseMoney(r[colMap.pboq]), fboq: parseMoney(r[colMap.fboq])
                };
            }).filter(x => x);

            const jobs = data.length;
            const wo = data.filter(d => d.wo).length;
            if (!isFirstLoad && Math.abs(jobs - lastValidStats.jobs) < 50 && wo < lastValidStats.wo * 0.8) {
                document.getElementById('stabilization-warning').classList.remove('hidden');
                return; 
            }
            
            rawData = data;
            
            if(isFirstLoad) {
                populateDropdowns(data);
                currentData = data;
                renderDashboard(currentData);
            } else {
                filterData();
            }

            lastValidStats = { jobs, wo, po: data.filter(d => d.po).length };
            isFirstLoad = false;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('stabilization-warning').classList.add('hidden');
            document.getElementById('last-updated').innerText = new Date().toLocaleTimeString('th-TH');
        }

        function populateDropdowns(data) {
            const regions = [...new Set(data.map(d => d.region))].sort();
            const statuses = [...new Set(data.map(d => d.status))].sort();
            
            const rSel = document.getElementById('region-filter');
            regions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.innerText = r;
                rSel.appendChild(opt);
            });

            const sSel = document.getElementById('status-filter');
            statuses.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s;
                sSel.appendChild(opt);
            });
        }

        function filterData() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const region = document.getElementById('region-filter').value;
            const status = document.getElementById('status-filter').value;
            const btn = document.getElementById('reset-filter-btn');

            if (search || region !== 'all' || status !== 'all') {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }

            currentData = rawData.filter(d => {
                const mSearch = !search || d.id.toLowerCase().includes(search) || d.project.toLowerCase().includes(search) || d.wo.toLowerCase().includes(search);
                const mRegion = region === 'all' || d.region === region;
                const mStatus = status === 'all' || d.status === status;
                return mSearch && mRegion && mStatus;
            });

            currentPage = 1; // Reset to page 1 on filter
            renderDashboard(currentData);
            renderDataTable(); // Update List View as well
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('region-filter').value = 'all';
            document.getElementById('status-filter').value = 'all';
            filterData();
        }

        function renderDashboard(data) {
            const total = data.length;
            const pboq = data.reduce((s, d) => s + d.pboq, 0);
            const fboq = data.reduce((s, d) => s + d.fboq, 0);
            const hasWO = data.filter(d => d.wo).length;
            const hasPO = data.filter(d => d.po).length;

            updateText('kpi-jobs', total.toLocaleString());
            updateText('kpi-pboq', pboq.toLocaleString());
            updateText('kpi-fboq', fboq.toLocaleString());
            updateText('kpi-wo', hasWO.toLocaleString());
            updateText('kpi-po', hasPO.toLocaleString());
            
            document.getElementById('prog-wo').style.width = total ? `${(hasWO/total)*100}%` : '0%';
            document.getElementById('prog-po').style.width = total ? `${(hasPO/total)*100}%` : '0%';

            renderCharts(data);
            renderGrid(data);
            renderTables(data);
        }

        // --- NEW: Data Table Logic ---
        function sortList(col) {
            if(sortCol === col) sortAsc = !sortAsc;
            else { sortCol = col; sortAsc = true; }
            renderDataTable();
        }

        function renderDataTable() {
            const tbody = document.getElementById('full-data-table-body');
            const start = (currentPage - 1) * rowsPerPage;
            
            // Sort
            const sorted = [...currentData].sort((a,b) => {
                let va = a[sortCol], vb = b[sortCol];
                if(typeof va === 'string') va = va.toLowerCase();
                if(typeof vb === 'string') vb = vb.toLowerCase();
                if (va < vb) return sortAsc ? -1 : 1;
                if (va > vb) return sortAsc ? 1 : -1;
                return 0;
            });

            const pageData = sorted.slice(start, start + rowsPerPage);
            document.getElementById('datalist-count').innerText = `${currentData.length.toLocaleString()} Records`;

            tbody.innerHTML = pageData.map(d => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0 transition">
                    <td class="font-mono text-gray-600">${d.id}</td>
                    <td class="font-medium text-gray-700">${d.project}</td>
                    <td class="text-gray-500">${d.region}</td>
                    <td>${getBadge(d.status)}</td>
                    <td class="text-gray-600 font-mono text-sm">${d.wo || '-'}</td>
                    <td class="text-purple-600 font-mono text-sm">${d.po || '-'}</td>
                    <td class="text-right font-mono text-gray-700">${d.pboq > 0 ? d.pboq.toLocaleString() : '-'}</td>
                </tr>
            `).join('');

            // Pagination Controls
            const totalPages = Math.ceil(currentData.length / rowsPerPage) || 1;
            document.getElementById('page-info').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage === totalPages;
        }

        function prevPage() { if(currentPage > 1) { currentPage--; renderDataTable(); } }
        function nextPage() { if(currentPage < Math.ceil(currentData.length/rowsPerPage)) { currentPage++; renderDataTable(); } }
        // ------------------------------

        function renderCharts(data) {
            const layout = { 
                margin: {t:20,b:40,l:40,r:20}, 
                font: {family:'Sarabun', size: 14, color:'#4B5563'}, 
                paper_bgcolor:'rgba(0,0,0,0)', 
                plot_bgcolor:'rgba(0,0,0,0)', 
                showlegend:false,
                xaxis: { showgrid: false, zeroline: false }, 
                yaxis: { showgrid: true, gridcolor: '#F3F4F6', zeroline: false } 
            };
            const config = { displayModeBar: false, responsive: true };

            // Region Chart
            const rEntries = Object.entries(countBy(data, 'region')).sort((a,b) => b[1] - a[1]);
            const barColors = rEntries.map(e => `rgba(99, 102, 241, ${0.6 + (e[1] / Math.max(...rEntries.map(x=>x[1]))) * 0.4})`);

            Plotly.react('chart-region', [{
                x: rEntries.map(e=>e[0]), y: rEntries.map(e=>e[1]), type: 'bar', 
                marker: { color: barColors, line: { color: 'rgba(99, 102, 241, 1)', width: 1 } }, 
                hovertemplate: '<b>%{x}</b><br>Jobs: %{y}<extra></extra>'
            }], { ...layout, xaxis: { automargin: true } }, config).then(gd => {
                gd.on('plotly_click', d => {
                    document.getElementById('region-filter').value = d.points[0].x;
                    filterData();
                });
            });

            // Project Chart
            const pSorted = Object.entries(countBy(data, 'project')).sort((a,b) => a[1] - b[1]).slice(-20);
            const hBarColors = pSorted.map(e => `rgba(20, 184, 166, ${0.6 + (e[1] / Math.max(...pSorted.map(x=>x[1]))) * 0.4})`);

            Plotly.react('chart-project-global', [{
                y: pSorted.map(x=>x[0]), x: pSorted.map(x=>x[1]), type: 'bar', orientation: 'h',
                marker: {color: hBarColors, line: { color: 'rgba(20, 184, 166, 1)', width: 1 }},
                hovertemplate: '<b>%{y}</b>: %{x} Jobs<extra></extra>'
            }], {...layout, margin:{l:140,r:20,t:10,b:30}, yaxis:{automargin:true, showgrid:false}, xaxis:{showgrid:true, gridcolor:'#F3F4F6'}}, config);

            // NEW: Global Status Chart (Donut)
            const sData = countBy(data, 'status');
            const sLabels = Object.keys(sData);
            const sValues = Object.values(sData);
            const sColors = sLabels.map(l => getStatusColor(l));

            Plotly.react('chart-status-global', [{
                labels: sLabels, values: sValues, type: 'pie', hole: 0.5,
                marker: { colors: sColors }, textinfo: 'none',
                hovertemplate: '<b>%{label}</b>: %{value} Jobs<extra></extra>'
            }], { 
                margin: {t:0,b:0,l:0,r:0}, showlegend: true, 
                legend: { orientation: 'h', x: 0, y: -0.1 },
                paper_bgcolor:'rgba(0,0,0,0)'
            }, config);
        }

        function renderGrid(data) {
            const container = document.getElementById('project-grid');
            container.innerHTML = '';
            const projects = [...new Set(data.map(d => d.project))];
            document.getElementById('project-count').innerText = `${projects.length} Projects`;
            
            const stats = projects.map(p => ({
                name: p,
                data: data.filter(d => d.project === p)
            })).sort((a, b) => b.data.length - a.data.length);

            stats.forEach((p, idx) => {
                const sData = countBy(p.data, 'status');
                const labels = Object.keys(sData);
                const values = Object.values(sData);
                const colors = labels.map(l => getStatusColor(l));
                
                // Simplified legend for performance
                const topStatus = labels.map((l,i) => ({l, v:values[i], c:colors[i]})).sort((a,b)=>b.v-a.v).slice(0,3);
                const legend = topStatus.map(x => `
                    <div class="flex justify-between items-center text-xs mt-1 text-gray-500">
                        <span class="flex items-center gap-1.5 truncate max-w-[100px]"><span class="w-2 h-2 rounded-full flex-shrink-0" style="background:${x.c}"></span>${x.l}</span>
                        <span class="font-bold">${x.v}</span>
                    </div>
                `).join('');

                const html = `
                    <div class="glass-card clickable-card p-5 hover:shadow-lg transition flex flex-col h-full border border-gray-100" onclick="openProjectModal('${p.name.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between mb-3 border-b border-gray-100 pb-2">
                            <span class="font-bold text-gray-700 truncate w-32 text-sm" title="${p.name}">${p.name}</span>
                            <span class="text-xs font-bold bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-lg">${p.data.length}</span>
                        </div>
                        <div class="flex items-center">
                            <div id="grid-chart-${idx}" class="w-20 h-20 flex-shrink-0 -ml-1 pointer-events-none"></div>
                            <div class="flex-grow ml-3 overflow-hidden">${legend}</div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);

                Plotly.newPlot(`grid-chart-${idx}`, [{
                    labels: labels, values: values, type: 'pie', hole: 0.7,
                    textinfo: 'none', hoverinfo: 'none', marker: {colors}, sort: false
                }], { margin: {t:0,b:0,l:0,r:0}, showlegend: false, paper_bgcolor:'rgba(0,0,0,0)' }, {displayModeBar: false});
            });
        }

        function openProjectModal(projectName) {
            const jobs = rawData.filter(d => d.project === projectName);
            const pboq = jobs.reduce((s, d) => s + d.pboq, 0);
            
            // Calculate Completion (Assume 'Complete' or 'Done' or '100' is finished)
            const completed = jobs.filter(d => {
                const s = (d.status||'').toLowerCase();
                return s.includes('complete') || s.includes('done') || s.includes('100');
            }).length;
            const pct = jobs.length ? Math.round((completed/jobs.length)*100) : 0;

            document.getElementById('modal-project-name').innerText = projectName;
            document.getElementById('modal-total-jobs').innerHTML = `<i class="fas fa-briefcase"></i> ${jobs.length} Jobs`;
            document.getElementById('modal-total-pboq').innerHTML = `<i class="fas fa-coins"></i> ${pboq.toLocaleString()} THB`;
            
            // Update Modal Progress Bar
            document.getElementById('modal-progress-text').innerText = `${pct}% Completed`;
            document.getElementById('modal-progress-bar').style.width = `${pct}%`;

            const rows = jobs.map(d => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0 transition-colors">
                    <td class="font-mono text-gray-600">${d.id}</td>
                    <td>${getBadge(d.status)}</td>
                    <td class="text-sm font-medium text-gray-600">${d.wo || '-'}</td>
                    <td class="text-sm text-purple-600 font-medium">${d.po || '-'}</td>
                    <td class="text-right font-mono text-gray-600">${d.pboq > 0 ? d.pboq.toLocaleString() : '-'}</td>
                    <td class="text-right font-mono text-green-600 font-bold">${d.fboq > 0 ? d.fboq.toLocaleString() : '-'}</td>
                </tr>
            `).join('');
            
            document.getElementById('modal-project-table').innerHTML = rows;
            document.getElementById('project-modal').style.display = 'flex';
        }

        function closeProjectModal() { document.getElementById('project-modal').style.display = 'none'; }

        function isActive(s) {
            s = (s||'').toLowerCase();
            return !s.includes('cancel') && !s.includes('reject') && !s.includes('');
        }

        function renderTables(data) {
            const mkRow = (d, type) => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0 transition group">
                    <td class="py-3 pl-4 text-left font-medium text-sm font-mono">${d.id}</td>
                    <td class="py-3 text-left font-medium text-gray-500 truncate max-w-[120px] text-sm" title="${type==='wo'?d.project:d.wo}">${type==='wo'?d.project:d.wo}</td>
                    <td class="py-3 pr-4 text-right font-medium text-right">${type==='wo' ? getBadge(d.status) : '<span class="text-gray-700 font-mono text-sm font-medium">'+d.pboq.toLocaleString()+'</span>'}</td>
                </tr>`;
            
            const noWO = data.filter(d => !d.wo && isActive(d.status)).slice(0, 50);
            const noPO = data.filter(d => d.wo && !d.po && isActive(d.status)).slice(0, 50);
            
            document.getElementById('table-missing-wo').innerHTML = noWO.map(d => mkRow(d, 'wo')).join('');
            document.getElementById('table-missing-po').innerHTML = noPO.map(d => mkRow(d, 'po')).join('');
            document.getElementById('count-missing-wo').innerText = noWO.length;
            document.getElementById('count-missing-po').innerText = noPO.length;
        }

        function parseMoney(val) { return parseFloat((val||'').toString().replace(/,/g,'').replace(/[^\d.-]/g,'')) || 0; }
        function countBy(arr, key) { const r={}; arr.forEach(x => r[x[key]]=(r[x[key]]||0)+1); return r; }
        function updateText(id, txt) { document.getElementById(id).innerText = txt; }
        
        function getStatusColor(s) {
            s = (s||'').toLowerCase();
            if(s.includes('re gate') || s.includes('re-gate')) return '#F87171'; 
            if(s.includes('') || s.includes('survey')) return '#A78BFA'; 
            if(s.includes('complete')||s.includes('100')||s.includes('done')) return '#34D399'; 
            if(s.includes('wait') && s.includes('gate')) return '#FBBF24'; 
            if(s.includes('wait') && s.includes('cut')) return '#FB923C'; 
            if(s.includes('wait')||s.includes('pending')) return '#9CA3AF'; 
            if(s.includes('cancel')||s.includes('fail')) return '#EF4444'; 
            if(s.includes('reject')) return '#F472B6'; 
            if(s.includes('pass')) return '#2DD4BF'; 
            if(s.includes('lay')) return '#22D3EE'; 
            if(s.includes('')) return '#818CF8'; 
            return '#CBD5E1'; 
        }

        function getBadge(s) {
            let cls = 'badge-gray';
            const ls = (s||'').toLowerCase();
            if(ls.includes('re gate') || ls.includes('re-gate')) cls='badge-re-gate';
            else if(ls.includes('') || ls.includes('survey')) cls='badge-surveyed';
            else if(ls.includes('complete')||ls.includes('100')||ls.includes('done')) cls='badge-completed';
            else if(ls.includes('wait') && ls.includes('gate')) cls='badge-wait-gate';
            else if(ls.includes('wait') && ls.includes('cut')) cls='badge-wait-cut';
            else if(ls.includes('wait')||ls.includes('pending')) cls='badge-wait-survey';
            else if(ls.includes('cancel')||ls.includes('fail')) cls='badge-cancel';
            else if(ls.includes('reject')) cls='badge-reject';
            else if(ls.includes('pass')) cls='badge-pass-gate';
            else if(ls.includes('lay')) cls='badge-lay-ofc';
            else if(ls.includes('')) cls='badge-assign';
            return `<span class="badge ${cls}">${s}</span>`;
        }

        function openPasteModal() { document.getElementById('paste-modal').style.display = 'flex'; }
        function closePasteModal() { document.getElementById('paste-modal').style.display = 'none'; }
        function processPasteData() {
            const t = document.getElementById('csv-paste-area').value;
            if(t) Papa.parse(t, {header:false, skipEmptyLines:true, complete:r=>{closePasteModal(); processData(r.data)}});
        }
        function exportToCSV() {
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([Papa.unparse(currentData)], {type:'text/csv'}));
            link.download = `project_cct_view_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>